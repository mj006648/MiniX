apiVersion: "sparkoperator.k8s.io/v1beta2"
kind: SparkApplication
metadata:
  name: trident-ai-ingestion-engine
  namespace: spark-operator
spec:
  type: Python
  mode: cluster
  image: "ich6648/spark-iceberg-nessie-kafka:11.0"
  imagePullPolicy: Always
  mainApplicationFile: "local:///mnt/scripts/generic_ingest.py"
  sparkVersion: "3.5.2"
  restartPolicy:
    type: Never

  # [사용자님이 기존에 사용하셨던 방식 그대로 유지]
  deps:
    packages:
      - org.apache.iceberg:iceberg-spark-runtime-3.5_2.12:1.6.1
      - org.projectnessie.nessie-integrations:nessie-spark-extensions-3.5_2.12:0.99.0
      - org.apache.hadoop:hadoop-aws:3.3.4
      - com.amazonaws:aws-java-sdk-bundle:1.12.749

  sparkConf:
    # [가장 중요한 설정] 권한 문제를 피하기 위해 Ivy 캐시 경로를 /tmp로 고정
    "spark.jars.ivy": "/tmp/.ivy2"
    
    # 시간대 및 JVM 설정
    "spark.sql.session.timeZone": "Asia/Seoul"
    "spark.driver.extraJavaOptions": "-Duser.timezone=Asia/Seoul"
    "spark.executor.extraJavaOptions": "-Duser.timezone=Asia/Seoul"
    
    # Nessie & Iceberg 연동 설정
    "spark.sql.extensions": "org.apache.iceberg.spark.extensions.IcebergSparkSessionExtensions,org.projectnessie.spark.extensions.NessieSparkSessionExtensions"
    "spark.sql.catalog.nessie": "org.apache.iceberg.spark.SparkCatalog"
    "spark.sql.catalog.nessie.catalog-impl": "org.apache.iceberg.nessie.NessieCatalog"
    "spark.sql.catalog.nessie.uri": "http://nessie.nessie-ns.svc.cluster.local:19120/api/v1"
    "spark.sql.catalog.nessie.warehouse": "s3a://iceberg2-data/warehouse"
    "spark.sql.catalog.nessie.io-impl": "org.apache.iceberg.hadoop.HadoopFileIO"
    
    # S3A 기본 프로토콜 설정
    "spark.hadoop.fs.s3a.impl": "org.apache.hadoop.fs.s3a.S3AFileSystem"
    "spark.hadoop.fs.s3a.path.style.access": "true"
    "spark.hadoop.fs.s3a.connection.ssl.enabled": "false"

  driver:
    serviceAccount: trident-spark-sa
    cores: 1
    memory: "1g"
    env:
      - name: TZ
        value: "Asia/Seoul"
    envFrom:
      - secretRef:
          name: trident-s3-creds
    volumeMounts:
      - name: scripts-volume
        mountPath: /mnt/scripts
  executor:
    instances: 1
    cores: 1
    memory: "2g"
    env:
      - name: TZ
        value: "Asia/Seoul"
    envFrom:
      - secretRef:
          name: trident-s3-creds
    volumeMounts:
      - name: scripts-volume
        mountPath: /mnt/scripts
  volumes:
    - name: scripts-volume
      configMap:
        name: trident-scripts
