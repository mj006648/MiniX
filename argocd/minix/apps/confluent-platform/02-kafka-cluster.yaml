# 파일: confluent-platform/02-kafka-cluster.yaml
apiVersion: platform.confluent.io/v1beta1
kind: Kafka
metadata:
  name: kafka
  namespace: confluent
spec:
  # ... (상단 설정은 기존과 동일) ...
  replicas: 3
  dataVolumeCapacity: 10Gi
  storageClass:
    name: rook-ceph-block-kafka
  image:
    application: confluentinc/cp-server:7.9.2
    init: confluentinc/confluent-init-container:2.11.2
  listeners:
    internal:
      name: INTERNAL
      port: 9071
      type: internal
    external:
      name: EXTERNAL
      externalAccess:
        type: loadBalancer
        # [수정] domain 대신 bootstrapService 를 명시하는 것이 더 명확합니다.
        # 이렇게 하면 Operator가 'kafka-bootstrap-lb' 라는 이름의 대표 LB를 생성합니다.
        loadBalancer:
          bootstrapService:
            name: kafka-bootstrap-lb
  # ... (podTemplate, dependencies 등 기존 설정 유지) ...
  dependencies:
    kRaftController:
      clusterRef:
        name: kraftcontroller
  configOverrides:
    server:
      - "inter.broker.listener.name=INTERNAL"
      - "listener.security.protocol.map=INTERNAL:PLAINTEXT,EXTERNAL:PLAINTEXT"

      # --- [★★★★★ 핵심 수정 사항 ★★★★★] ---
      # 이 설정을 추가해야 외부 클라이언트가 정상적으로 접속할 수 있습니다.
      - "advertised.listeners=INTERNAL://kafka-$(KAFKA_BROKER_ID).kafka.confluent.svc.cluster.local:9071,EXTERNAL://${CFK_EXTERNAL_LISTENER_HOST}:$(CFK_EXTERNAL_LISTENER_PORT)"
      # [설명]
      # - INTERNAL://... : 내부 컴포넌트에게는 내부 주소를 알려준다.
      # - EXTERNAL://... : 외부 클라이언트에게는 Confluent Operator가 자동으로 생성한
      #                   각 브로커의 외부 LoadBalancer IP(${CFK_EXTERNAL_LISTENER_HOST})와
      #                   포트(${CFK_EXTERNAL_LISTENER_PORT})를 알려준다.
      # ---------------------------------------------

      - "min.insync.replicas=2"
      # ... (기타 내부 토픽 복제본 수 설정은 기존과 동일) ...
      - "confluent.license.topic.replication.factor=3"
      - "confluent.metrics.reporter.topic.replication.factor=3"
      - "confluent.controlcenter.internal.topics.replication.factor=3"
      - "confluent.controlcenter.command.topic.replication.factor=3"
      - "confluent.monitoring.interceptor.topic.replication.factor=3"
      - "confluent.schema.topic.replication.factor=3"
      - "default.replication.factor=3"
